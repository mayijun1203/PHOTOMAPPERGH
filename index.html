<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }

        #mainmap {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="container-fluid p-0" id="mainmap"> </div> <!-- placeholder for main map -->

    <script>
        'use strict';
        // Set MapBox token
        mapboxgl.accessToken = 'pk.eyJ1IjoibWF5aWp1biIsImEiOiJjaXg4ZmlyY20wMDBjMm9tcjI0bjQ0Z21zIn0.Io0XJ4JelN903V9HGo4TfQ'; // still need to find a way to store the token


        // Initialize the map
        const map = new mapboxgl.Map({ // creating a new map
            container: 'mainmap', // same as the div id to place the map
            style: 'mapbox://styles/mapbox/light-v10', // light base map
            hash: true, // make sure it's on to get the url with map view
            preserveDrawingBuffer: true, // make sure it's on to allow printing
            center: [119.655953, 29.093875], // testing to get the centroid of bounds
            zoom: 11, // set the initial zoom of the map view
        });


        // Add layers
        map.on('load', function () {
            map.loadImage(
                'icon.png',
                (error, image) => {
                    if (error) throw error;

                    // Add the image to the map style.
                    map.addImage('dirarrow', image);


                    const layerContentList = []; // store all the layer contents

                    // Add full screen control
                    map.addControl(new mapboxgl.FullscreenControl({
                        container: document.querySelector('body'),
                    }),
                        'bottom-left', // control position
                    );

                    // Add navigation control
                    map.addControl(new mapboxgl.NavigationControl({
                        showCompass: true, // show compass
                        showZoom: true, // show zoom
                        visualizePitch: true, // show pitch
                    }),
                        'bottom-left', // control position
                    );


                    // Add points
                    // Set layer contents
                    const layerContent = {
                        'sourceid': 'ptsource', // source id
                        'sourcetype': 'geojson', // source type
                        'sourcedata': 'photoviz.geojson', // data source
                        'cluster': true, // whether enable clustering
                        'clustermaxzoom': 18, // max zoom level for clustering
                        'clusterradius': 50, // radius of clusters
                        'unclusteredid': 'unclustered', // layer id
                        'unclusteredtype': 'symbol', // symbology type
                        'unclusteredvisibility': 'visible', // visibility of the layer
                        'unclusteredopacity': 1, // circle opacity
                        'unclusteredsize': 0.07, // circle radius; change size based on zoom level
                        'unclusteredoutlinecolor': 'rgba(255,255,255,0)',  // outline color; for legend purpose only
                        'clusteredid': 'clustered', // layer id
                        'clusteredtype': 'circle', // symbology type
                        'clusteredvisibility': 'visible', // visibility of the layer
                        'clusteredcolor': ['step', ['get', 'point_count'], '#51bbd6', 1, '#f1f075', 3, '#f28cb1'], // color for each category; use rgba
                        'clusteredopacity': 1, // circle opacity
                        'clusteredradius': ['step', ['get', 'point_count'], 20, 100, 30, 750, 40], // circle radius; change size based on point counts
                        'clusteredstrokecolor': 'rgb(255,255,255)', // circle stroke color
                        'clusteredstrokeopacity': 1, // circle stroke opacity
                        'clusteredstrokewidth': 0, // circle stroke width
                        'clusteredoutlinecolor': 'rgba(255,255,255,0)',  // outline color; for legend purpose only
                        'clusterlabelid': 'clusterlabel',
                        'clusterlabeltype': 'symbol', // symbology type
                        'clusterlabelvisibility': 'visible', // visibility of the layer
                        'clusterlabeltextfield': ['get', 'point_count_abbreviated'], // text for the cluster label
                        'clusterlabeltextfont': ['Open Sans Semibold', 'Arial Unicode MS Bold'], // text font for the cluster label
                        'clusterlabeltextsize': 14, // text size for the cluster label
                    };

                    // Add layer content to the overall layer content list
                    layerContentList.push(layerContent);

                    // Add data source
                    map.addSource(layerContent['sourceid'], {
                        'type': layerContent['sourcetype'],
                        'data': layerContent['sourcedata'],
                        'cluster': layerContent['cluster'],
                        'clusterMaxZoom': layerContent['clustermaxzoom'],
                        'clusterRadius': layerContent['clusterradius'],
                    });

                    // Add unclustered circle layer
                    map.addLayer({
                        'id': layerContent['unclusteredid'],
                        'type': layerContent['unclusteredtype'],
                        'source': layerContent['sourceid'],
                        'filter': ['!', ['has', 'point_count']],
                        'layout': {
                            'visibility': layerContent['unclusteredvisibility'],
                            'icon-image': 'dirarrow',
                            'icon-size': layerContent['unclusteredsize'],
                            'icon-rotate': ['get', 'bearing'],
                        },
                        'paint': {
                            'icon-opacity': layerContent['unclusteredopacity'],
                        },
                    });

                    // Add clustered circle layer
                    map.addLayer({
                        'id': layerContent['clusteredid'],
                        'type': layerContent['clusteredtype'],
                        'source': layerContent['sourceid'],
                        'filter': ['has', 'point_count'],
                        'layout': {
                            'visibility': layerContent['clusteredvisibility'],
                        },
                        'paint': {
                            'circle-color': layerContent['clusteredcolor'],
                            'circle-opacity': layerContent['clusteredopacity'],
                            'circle-radius': layerContent['clusteredradius'],
                            'circle-stroke-color': layerContent['clusteredstrokecolor'],
                            'circle-stroke-opacity': layerContent['clusteredstrokeopacity'],
                            'circle-stroke-width': layerContent['clusteredstrokewidth'],
                        },
                    });

                    // Add clustered label layer
                    map.addLayer({
                        'id': layerContent['clusterlabelid'],
                        'type': layerContent['clusterlabeltype'],
                        'source': layerContent['sourceid'],
                        'filter': ['has', 'point_count'],
                        'layout': {
                            'visibility': layerContent['clusterlabelvisibility'],
                            'text-field': layerContent['clusterlabeltextfield'],
                            'text-font': layerContent['clusterlabeltextfont'],
                            'text-size': layerContent['clusterlabeltextsize'],
                        },
                    });

                    console.log(map.getSource('ptsource'))


                    // Click on a cluster
                    map.on('click', 'clustered', (e) => {
                        const features = map.queryRenderedFeatures(e.point, {
                            layers: ['clustered'],
                        });
                        const clusterId = features[0].properties.cluster_id;
                        map.getSource('ptsource').getClusterExpansionZoom(
                            clusterId,
                            (err, zoom) => {
                                if (err) return;
                                map.easeTo({
                                    center: features[0].geometry.coordinates,
                                    zoom: zoom,
                                });
                            }
                        );
                    });
                    // Add hover events
                    map.on('mouseenter', 'clustered', () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', 'clustered', () => {
                        map.getCanvas().style.cursor = '';
                    });


                    // Add popup
                    const popup = new mapboxgl.Popup({
                        closeButton: true, // close button
                        closeOnClick: true, // close if click on map
                        closeOnMove: false, // close if move the map
                        anchor: 'bottom', // anchor of the popup
                        offset: 0, // offset from the feature
                        maxWidth: 'none', // max width of the popoup; 'none' to fit to the content                
                    });

                    // Add unclustered popup
                    // Add click event
                    function clickOnMap(e) {
                        map.easeTo({
                            center: [e.features[0].geometry.coordinates[0], e.features[0].geometry.coordinates[1] + 0.0003],
                            zoom: 18,
                        });
                        const coordinates = e.features[0].geometry.coordinates.slice(); // get point coordinates
                        var description = "<b>Photo ID: </b><span>" + e.features[0].properties.img + "</span><br>"; // description in the popup
                        description += "<b>Datetime: </b><span>" + e.features[0].properties.datetime + "</span><br>";
                        description += "<b>Bearing: </b><span>" + e.features[0].properties.bearing + "</span><br>";
                        description += "<a target='_blank' href='" + e.features[0].properties.img + "'><img src=img/" + e.features[0].properties.img + " width=300rem>"
                        popup.setLngLat(coordinates).setHTML(description).addTo(map); //add popup
                    }
                    map.on('click', 'unclustered', clickOnMap);
                    // Add hover events
                    map.on('mouseenter', 'unclustered', function () {
                        map.getCanvas().style.cursor = 'pointer'; // mouse becoming pointer
                    });
                    map.on('mouseleave', 'unclustered', function () {
                        map.getCanvas().style.cursor = '';
                    });
                });
        });
    </script>
</body>

</html>